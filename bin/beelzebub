#!/usr/bin/env node
'use strict';

const _          = require('lodash');
const path       = require('path');
const cli        = require('commander');
const Beelzebub  = require('../index.js');
const manifest   = require('../package.json');
const currentDir = process.cwd();

cli.version(manifest.version)
   .option('-f, --file <file>', 'Load file')
   .parse(process.argv);

const bz = Beelzebub({ verbose: true });
const runTasks  = cli.args; // tasks to run
let allTasks = [];


// TODO: use transfuser
function loadFile(tasks, file, displayError){
  try {
    // need to join the current dir,
    // because require is relative to THIS file not the running process
    if(!path.isAbsolute(file)) {
      file = path.join(currentDir, file);
    }
    
    let fTasks = require( file );
    if(fTasks) {
      tasks = _.merge(tasks, fTasks);
    }
  } catch(err) {
    if(displayError) {
      console.error('File ('+file+') Load Error:', err);
    }
  }

  return tasks;
}

// console.info('BZ CLI file:', cli.file);
if(cli.file) {
  allTasks = loadFile(allTasks, cli.file, true);
}

// check if beelzebub.js/json file
allTasks = loadFile(allTasks, './beelzebub.js');
allTasks = loadFile(allTasks, './beelzebub.json');
allTasks = loadFile(allTasks, './bz.js');
allTasks = loadFile(allTasks, './bz.json');

if(!allTasks || !_.isArray(allTasks) || !allTasks.length) {
  console.error('No Tasks Loaded');
  process.exit();
  return;
}

if(!runTasks || !_.isArray(runTasks) || !runTasks.length) {
  console.error('No Tasks to Run');
  process.exit();
  return;
}

allTasks.map( (task) => {
  bz.add(task);
});

bz.run(...runTasks);
